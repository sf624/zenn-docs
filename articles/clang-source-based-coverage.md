---
title: "Clang„ÅÆ„ÇΩ„Éº„Çπ„Éô„Éº„Çπ„Éâ(source-based)„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨"
emoji: "üìî"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["c", "cpp", "clang", "llvm", "coverage"]
published: false
---

## „Åì„ÅÆË®ò‰∫ã„ÇíË™≠„ÇÄ„Å®‚Ä¶

- clang„ÅÆsource based„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅÆË®àÊ∏¨„ÉªÂèñÂæóÊñπÊ≥ï„ÅåÂàÜ„Åã„Çä„Åæ„Åô
- MC/DC„Ç´„Éê„É¨„ÉÉ„Ç∏„Å™„Å©„ÅÆ„ÄÅÈ´òÁ≤æÂ∫¶„Å™„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨„Åå„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô

## „ÅØ„Åò„ÇÅ„Å´

C/C++„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨ÊâãÊ≥ï„Å´„Å§„ÅÑ„Å¶„ÅØgcov„ÅåÁâπ„Å´ÊúâÂêç„Åß„ÅÇ„Çã„Åå„ÄÅLLVM„ÅØÁã¨Ëá™„Å´"source-based"„Ç´„Éê„É¨„ÉÉ„Ç∏„Å®Âëº„Å∞„Çå„ÇãÊâãÊ≥ï„ÇíÊèê‰æõ„Åó„Å¶„ÅÑ„Çã„ÄÇgcov„Åß„ÅØ„ÄÅ„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨Áî®„ÅÆ„Ç≥„Éº„ÉâÔºàinstrumentÔºâ„Åå„Ç≥„É≥„Éë„Ç§„É´„ÅÆÊúÄÁµÇÊÆµÈöé„ÅßÊåøÂÖ•„Åï„Çå„Çã„Åü„ÇÅÊúÄÈÅ©Âåñ„Å™„Å©„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„ÇÑ„Åô„ÅÑ„ÄÇ‰∏ÄÊñπ„Åß„ÄÅ"source-based"„Ç´„Éê„É¨„ÉÉ„Ç∏„Åß„ÅØ„Åù„ÅÆÂêç„ÅÆÈÄö„Çä„ÄÅ„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„É¨„Éô„É´„Åßinstrument„ÅåÊåøÂÖ•„Åï„Çå„Çã„Åü„ÇÅ[„Åª„ÅºÊúÄÈÅ©Âåñ„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ](https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#impact-of-llvm-optimizations-on-coverage-reports)È´òÁ≤æÂ∫¶„Å™„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆö„ÅåÂèØËÉΩ„Å®„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇ

Áâπ„Å´„ÄÅLLVM18„Åã„Çâ„ÅØ[MC/DC](https://en.wikipedia.org/wiki/Modified_condition/decision_coverage)Ôºà‰øÆÊ≠£Êù°‰ª∂ÔºèÊ±∫ÂÆöÁ∂≤ÁæÖÔºâ„Å®„ÅÑ„ÅÜÁ®ÆÈ°û„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅåË®àÊ∏¨„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„ÄÅ„Çà„ÇäÁ≤æÂØÜ„ÅßÂÆüÁî®ÁöÑ„Å™„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨„ÅåÂèØËÉΩ„Å®„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇ„Åù„Åì„Åß„Åì„ÅÆË®ò‰∫ã„Åß„ÅØ„ÄÅ"source-based"„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅÆÂü∫Êú¨ÁöÑ„Å™Ë®àÊ∏¨ÊñπÊ≥ï„ÇíË™¨Êòé„Åó„ÄÅ„Åù„ÅÆË®àÊ∏¨ÁµêÊûú„ÇíÁ¢∫Ë™ç„Åô„Çã„ÄÇ

‰ªäÂõû„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆclang„ÅÆ"source based code coverage"„ÅÆÂÖ¨Âºè„É¨„Éï„Ç°„É¨„É≥„Çπ„Çí„ÇÇ„Å®„Å´Ëß£Ë™¨„Åó„Åü„ÄÇ

https://clang.llvm.org/docs/SourceBasedCodeCoverage.html

„Åæ„Åü„ÄÅ‰ª•‰∏ã„ÅÆË®ò‰∫ã„ÇÇÂèÇËÄÉ„Å´„Åï„Åõ„Å¶„ÅÑ„Åü„Å†„ÅÑ„Åü„ÄÇ

https://qiita.com/joule/items/f9de29ceb1d78c5658d8

## LLVM„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„Å´„Å§„ÅÑ„Å¶

ÁèæÊôÇÁÇπÔºà2025Âπ¥7ÊúàÔºâ„ÅßÂÆâÂÆöÁâà„ÅÆÊúÄÊñ∞Áâà„Åß„ÅÇ„ÇãLLVM 20„Çí‰ΩøÁî®„Åô„Çã„ÄÇ

```sh
$ clang++-20 --version
Ubuntu clang version 20.1.8 (++20250708082440+6fb913d3e2ec-1~exp1~20250708202457.136)
Target: x86_64-pc-linux-gnu
Thread model: posix
InstalledDir: /usr/lib/llvm-20/bin
```

„Ç§„É≥„Çπ„Éà„Éº„É´„Åô„ÇãÂ†¥Âêà„ÄÅ`llvm.sh`„ÇíÁî®„ÅÑ„Çã„ÅÆ„ÅåÊúÄ„ÇÇÁ∞°Âçò„Åß„ÅÇ„Çã„ÄÇ([ref](https://apt.llvm.org/))

```sh
wget https://apt.llvm.org/llvm.sh
chmod +x llvm.sh
sudo ./llvm.sh 20
```

## „Åù„ÅÆ‰ªñ„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆöÊâãÊ≥ï„Å´„Å§„ÅÑ„Å¶

clang„Å´„ÅØ3„Å§„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆöÊâãÊ≥ï„Åå„ÅÇ„Çä„ÄÅÊ∑∑Âêå„Åô„Çã„Å®ËâØ„Åè„Å™„ÅÑ„ÅÆ„Åß‰∫à„ÇÅË™¨Êòé„Åô„Çã„ÄÇ

- gcov: GCC„ÅåÊèê‰æõ„Åô„Çã„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆö„ÄÇÊúÄ„ÇÇ„Çà„ÅèÁü•„Çâ„Çå„Å¶„ÅÑ„Çã„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆöÊâãÊ≥ï„ÄÇ
- Sanitizer Coverage: ËªΩÈáè„Ç´„Éê„É¨„ÉÉ„Ç∏„ÄÇÂÆüË°åÂõûÊï∞„Å™„Å©„ÅÆ„Ç´„Ç¶„É≥„Éà„ÅØ„Åõ„Åö„ÄÅÂà∞ÈÅî„Åó„Åü„Åã„Å©„ÅÜ„Åã„Å†„ÅëÊ∏¨ÂÆö„Åô„Çã„ÄÇ
- Source based code coverage: LLVM„ÅåÁã¨Ëá™„Å´Êèê‰æõ„Åô„Çã„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆö„ÄÇgcov„Çà„Çä„ÇÇË©≥Á¥∞„Å™Ê∏¨ÂÆö„ÅåÂèØËÉΩ„Åß„ÅÇ„Çä„ÄÅÊúÄÈÅ©Âåñ„Å´„Çà„ÇãÂΩ±Èüø„ÇíÂèó„Åë„Å•„Çâ„ÅÑ„ÄÇ

„Åì„ÅÆ„ÅÜ„Å°„ÄÅ‰ªäÂõûË™¨Êòé„Åô„Çã„ÅÆ„ÅØÊúÄÂæå„ÅÆ"source based"„Ç´„Éê„É¨„ÉÉ„Ç∏„Åß„ÅÇ„Çã„ÄÇ

Áâπ„Å´gcov„Å®„ÅÆÈÅï„ÅÑ„Å´„ÅØÊ≥®ÊÑè„ÇíË¶Å„Åô„Çã„ÄÇgcc‰∫íÊèõ„Å™clang„ÇÇgcov‰ªïÊßò„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„ÅÑ„Çã„Åå„ÄÅ"source based"„Ç´„Éê„É¨„ÉÉ„Ç∏„Å®„ÅØÂà•Áâ©„Åß„ÅÇ„Çä„ÄÅ„Éç„ÉÉ„Éà„ÅßÊ§úÁ¥¢„Åó„Å¶„ÅÑ„Å¶ÊúÄ„ÇÇ„Éí„ÉÉ„Éà„Åó„ÇÑ„Åô„ÅÑ„ÅÆ„ÅØ„Åì„Å°„Çâ„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„Åß„ÅÇ„Çã„ÄÇ**`--coverage`„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊåáÂÆö„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Åì„ÅÆgcovÂΩ¢Âºè„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅåË®àÊ∏¨„Åï„Çå„Çã„ÄÇ**

```sh
# „Åì„Çå„Çâ„ÅØgcov‰ªïÊßò„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„ÇíË®àÊ∏¨„Åô„Çã„Ç≥„É≥„Éë„Ç§„É´
g++ --coverage foo.cpp
clang++ --coverage foo.cpp
```

ÂØæ„Åó„Å¶„ÄÅ‰ªäÂõûË™¨Êòé„Åô„Çãsorce-based„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅØ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´**ÊåáÂÆö„Åô„Çã„Ç™„Éó„Ç∑„Éß„É≥„ÅåÁï∞„Å™„Çã**„ÄÇÔºà„Å™„Åä„ÄÅ‰∏äË®ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Å®ÁµÑ„ÅøÂêà„Çè„Åõ„ÅüÂ†¥Âêà„ÅØ„ÄÅgcov„Å®"source-based"„ÅÆ‰∏°Êñπ„Å´„Çà„Çã„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨„ÅåÂÆüÊñΩ„Åï„Çå„Çã„ÄÇÔºâ

```sh
# „Åì„Çå„ÅØ"source based code coverage"‰ªïÊßò„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„ÇíË®àÊ∏¨„Åô„Çã„Ç≥„É≥„Éë„Ç§„É´
clang++ -fprofile-instr-generate -fcoverage-mapping foo.cpp
```

„Åì„ÅÆ„ÅÇ„Åü„Çä„ÄÅ‰∫ãÊÉÖ„Åå„ÇÑ„ÇÑ„Åì„Åó„ÅèÊ∑∑Âêå„Åó„ÇÑ„Åô„ÅÑ„Åü„ÇÅ„ÄÅ‰ª•‰∏ã„Å´„Çà„Åè„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆö„ÅßÂá∫„Å¶„Åè„Çã„Ç≥„Éû„É≥„Éâ„ÉªÁî®Ë™ûÂêç„Å®„Åù„ÅÆÊÑèÂë≥„ÇíÁ§∫„Åô„ÄÇÂêçÂâç„ÅåÁ¥õ„Çâ„Çè„Åó„ÅÑ„Åå„ÄÅ**`lcov`„ÅØ`llvm-cov`„Å®„ÅØÂà•Áâ©„Åß**„ÄÅË®ò‰∫ã„ÅÆÊúÄÂæå„Å´ÁôªÂ†¥„Åô„ÇãHTML„ÅÆ„É¨„Éù„Éº„Éà„ÅØ`lcov`„ÅÆÊ©üËÉΩ„Åß„ÅØ„Å™„Åè„ÄÅ`llvm-cov show`„Å´„Çà„Çã„ÇÇ„ÅÆ„Åß„ÅÇ„Çã„ÄÇ

| Áî®Ë™û | ÂΩπÂâ≤ | Èñ¢ÈÄ£„Åô„Çã„Éï„Ç°„Ç§„É´ |
| - | - | - |
| `gcov` | "GCC"„ÅåÊèê‰æõ„Åô„Çã„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆö„ÉÑ„Éº„É´„Åä„Çà„Å≥„Åù„ÅÆ‰ªïÊßò | `.gcda`„ÄÅ`.gcno` |
| `lcov` | "linux-test-project"„ÅåÊèê‰æõ„Åô„Çãgcov„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„ÇíHTML„Å™„Å©„Åß„Ç∞„É©„Éï„Ç£„Ç´„É´„Å´Ë°®Á§∫„Åô„Çã„ÉÑ„Éº„É´ | `.gcda`„ÄÅ `.gcno`„ÄÅ`.info` |
| `llvm-profdata` | "LLVM"Áã¨Ëá™„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„Éá„Éº„Çø„Åß„ÅÇ„Çã`.profraw`„Éï„Ç°„Ç§„É´„Çí`.profdata`„Å®„Åó„Å¶ÈõÜÁ¥Ñ„Åô„Çã„ÉÑ„Éº„É´ | `.profraw`„ÄÅ`.profdata` |
| `llvm-cov` | "LLVM"„ÅåÊèê‰æõ„Åô„Çãclang„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆö„ÉªË°®Á§∫„ÉÑ„Éº„É´„ÄÇgcov„Å®LLVMÁã¨Ëá™„ÅÆ"source based code coverage"„ÅÆ‰∏°‰ªïÊßò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Çã | `.profdata` |


## source-based„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅÆË®àÊ∏¨„ÉªË°®Á§∫„ÅÆÊµÅ„Çå

„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨„ÉªË°®Á§∫„ÅÆÂÖ®‰ΩìÂÉè„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„Åß„ÅÇ„Çã„ÄÇ

1. „Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆöÁî®„ÅÆ"instrument code"„ÇíÊåøÂÖ•„Åó„ÅüÁä∂ÊÖã„Åß„ÄÅÊ∏¨ÂÆöÂØæË±°„ÅÆ„Éó„É≠„Ç∞„É©„É†„Çí„Ç≥„É≥„Éë„Ç§„É´„Åô„Çã„ÄÇ

    ```sh
    clang++ foo.cpp -o foo \
        -fprofile-instr-generate \
        -fcoverage-mapping
    ```

2. Âá∫Êù•‰∏ä„Åå„Å£„Åü„Éó„É≠„Ç∞„É©„É†„ÇíÂÆüË°å„Åó„ÄÅ`.profraw`„Å®„ÅÑ„ÅÜÁîü„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê„Åô„Çã„ÄÇ

    ```sh
    LLVM_PROFILE_FILE="foo.profraw" ./foo
    ```

3. Áîü„Éó„É≠„Éï„Ç°„Ç§„É´„Çí`.profdata`„Å®„ÅÑ„ÅÜ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ªò„Åç„Éó„É≠„Éï„Ç°„Ç§„É´„Å´ÈõÜÁ¥Ñ„Åô„Çã„ÄÇ

    ```sh
    llvm-profdata merge -sparse foo.profraw -o foo.profdata
    ```

4. „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ªò„Åç„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíË°®Á§∫„Åô„Çã„ÄÇ

    ```sh
    llvm-cov show ./foo -instr-profile=foo.profdata
    ```

‰ª•‰∏ã„ÄÅ„Åì„Çå„Çâ„ÅÆÊâãÈ†Ü„Å´„Å§„ÅÑ„Å¶Ë©≥Á¥∞„ÇíË™¨Êòé„Åô„Çã„ÄÇ

## Ê∏¨ÂÆöÂØæË±°„ÅÆ„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ

‰ªäÂõû„ÅØ„ÄÅ‰∏ãË®ò„ÅÆ„Çà„ÅÜ„Å™„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨„ÇíË°å„ÅÜ„ÇÇ„ÅÆ„Å®„Åô„Çã„ÄÇ`main.cpp`„ÄÅ`foo.hpp`„ÄÅ`bar.cpp`„ÄÅ`bar.hpp`„ÅÆ4„Å§„ÅÆ„Éï„Ç°„Ç§„É´„Åã„ÇâÊßãÊàê„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ

- `bar`„ÅØÊôÆÈÄö„ÅÆÈñ¢Êï∞„Åß„ÅÇ„Çä„ÄÅMC/DC„Ç´„Éê„É¨„ÉÉ„Ç∏„Åå100%„Å®„Å™„Çã„Çà„ÅÜ„Å´Ë§áÊï∞ÂõûÂÆüË°å„Åó„Å¶„ÅÑ„Çã„ÄÇ

- `foo`„ÅØ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈñ¢Êï∞„Å®„Å™„Å£„Å¶„Åä„Çä„ÄÅ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éë„É©„É°„Éº„Çø„ÇíÂå∫Âà•„Åó„Å™„Åë„Çå„Å∞`bar`„Å®ÂêåÊßò„ÅÆÊù°‰ª∂ÂàÜÂ≤êÁ∂≤ÁæÖ„Å®„Å™„Çã„Çà„ÅÜ„Å´ÂÆüË°å„Åó„Å¶„ÅÑ„Çã„Åå„ÄÅÂÆüÈöõ„Å´„ÅØ`int`„Å®`long`„ÅÆ‰∫å„Å§„ÅÆÂûã„ÅßÂÆü‰ΩìÂåñ„Åï„Çå„Å¶„ÅÑ„Å¶„ÄÅ„Åù„Çå„Åû„Çå„ÅÆÂÆü‰ΩìÂåñ„Å´„Å§„ÅÑ„Å¶„ÅØMC/DC„Ç´„Éê„É¨„ÉÉ„Ç∏„Åå100%„Å®„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Å™„Å£„Å¶„ÅÑ„Çã„ÄÇ

https://github.com/sf624/zenn-docs/blob/main/sample_codes/clang-source-based-coverage/main.cpp

https://github.com/sf624/zenn-docs/blob/main/sample_codes/clang-source-based-coverage/bar.hpp

https://github.com/sf624/zenn-docs/blob/main/sample_codes/clang-source-based-coverage/bar.cpp

https://github.com/sf624/zenn-docs/blob/main/sample_codes/clang-source-based-coverage/foo.hpp

„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„ÅØ„ÄÅ`coverage.sh`„ÅßÂèñÂæó„Åß„Åç„Çã„ÄÇË©≥Á¥∞„Å´„Å§„ÅÑ„Å¶‰ª•‰∏ã„Å´Ë™¨Êòé„Åô„Çã„ÄÇ

https://github.com/sf624/zenn-docs/blob/main/sample_codes/clang-source-based-coverage/coverage.sh

## 1. „Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆöÁî®„Ç≥„É≥„Éë„Ç§„É´

„Åæ„Åö„ÄÅÊ∏¨ÂÆöÂØæË±°„ÅÆ„Éó„É≠„Ç∞„É©„É†„Çí„ÄÅ„Ç´„Éê„É¨„ÉÉ„Ç∏Ë®àÊ∏¨Áî®„ÅÆ"instrument code"„ÇíÊåøÂÖ•„Åó„ÅüÁä∂ÊÖã„Åß„Ç≥„É≥„Éë„Ç§„É´„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„ÄÇ„Åì„Çå„Å´„ÅØ„ÄÅ`-fcoverage-mapping -fcoverage-mcdc`„Å®„ÅÑ„ÅÜ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊåáÂÆö„Åô„Çå„Å∞„Çà„ÅÑ„ÄÇ

```sh
# „Ç§„É≥„Çπ„Éà„Ç•„É´„É°„É≥„Éà„Ç≥„Éº„Éâ‰ªò„Åç„Åß„Ç≥„É≥„Éë„Ç§„É´
clang++-20 main.cpp bar.cpp -o main \
    -fprofile-instr-generate \
    -fcoverage-mapping \
    -fcoverage-mcdc
```

:::message
MCDC„Ç´„Éê„É¨„ÉÉ„Ç∏„ÇÇË°®Á§∫„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄÅ‰∏äË®ò„ÅÆ„Çà„ÅÜ„Å´`-fcoverage-mcdc`„ÇíËøΩÂä†„Åô„Çã„ÄÇ
:::

## 2. „Ç´„Éê„É¨„ÉÉ„Ç∏Ê∏¨ÂÆö

„Ç´„Éê„É¨„ÉÉ„Ç∏„Ç≥„Éº„Éâ„ÅåÊåøÂÖ•„Åï„Çå„Åü„Éó„É≠„Ç∞„É©„É†„ÇíÂÆüË°å„Åô„Çã„Å®„ÄÅ`LLVM_PROFILE_FILE`Áí∞Â¢ÉÂ§âÊï∞„Å´Ë®≠ÂÆö„Åï„Çå„Åü„Éë„Çπ„Å´„ÄÅ„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„ÅåÂê´„Åæ„Çå„ÇãÁîü„Éó„É≠„Éï„Ç°„Ç§„É´Ôºà"raw profile"Ôºâ„ÅåÁîüÊàê„Åï„Çå„Çã„ÄÇ

```sh
# Áîü„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê
LLVM_PROFILE_FILE="main.profraw" ./main
```

„Åì„ÅÆÁí∞Â¢ÉÂ§âÊï∞„ÇíË®≠ÂÆö„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅØ„ÄÅ„Ç´„É¨„É≥„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´`default.profraw`„Å®„Åó„Å¶ÁîüÊàê„Åï„Çå„Çã„ÄÇ

```sh
# „Éë„Çπ„ÇíÊåáÂÆö„Åó„Å™„Åë„Çå„Å∞„ÄÅ`./default.profraw`„Å´ÁîüÊàê„Åï„Çå„Çã
./main
```

‰ΩïÂ∫¶„ÇÇÂêå„Åò„Éó„É≠„Ç∞„É©„É†„ÇíÂÆüË°å„Åô„ÇãÂ†¥Âêà„ÄÅÁîü„Éó„É≠„Éï„Ç°„Ç§„É´„Åå‰∏äÊõ∏„Åç„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´Áï∞„Å™„Çã„Éë„Çπ„ÇíÊåáÂÆö„Åó„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ„ÄÇ„Åü„Å®„Åà„Å∞`%p`„Å®„ÅÑ„Å£„Åü„Éë„Çø„Éº„É≥„Çπ„Éà„É™„É≥„Ç∞„Çí„Éë„ÇπÂêç„Å´ÊåøÂÖ•„Åô„Çã„Å®„Éó„É≠„Çª„ÇπID„Å´ÁΩÆÊèõ„Åó„Å¶„Åè„Çå„Çã„ÄÇ„Åì„Çå„Çâ„ÅÆÂà©Áî®ÂèØËÉΩ„Å™„Éë„Çø„Éº„É≥„ÅÆË©≥Á¥∞„ÅØ[„Åì„Å°„Çâ](https://clang.llvm.org/docs/SourceBasedCodeCoverage.html#running-the-instrumented-program)„ÇíÂèÇÁÖß„ÄÇ

```sh
# „Éó„É≠„Çª„ÇπID‰ªò„Åç„ÅßÁîü„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê
LLVM_PROFILE_FILE="main-%p.profraw" ./main
```

### gcov„Å®„ÅÆÈÅï„ÅÑ

gcov„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´„Åî„Å®„Å´`.gcno`„Å®`.gcda`„Éï„Ç°„Ç§„É´„ÅåÁîüÊàê„Åï„Çå„Åü„ÄÇ„Åó„Åã„Åó„ÄÅ„Åì„Å°„Çâ„ÅÆ`llvm-cov`„ÅÆ"source based code coverage"„ÅÆÂ†¥Âêà„ÅØ„ÄÅ**1ÂÆüË°å„Åî„Å®„Å´1„Å§**„ÅÆ`.profraw`„ÅåÁîüÊàê„Åï„Çå„Çã„ÄÇÂæì„Å£„Å¶„ÄÅgcov„ÅÆ„Çà„ÅÜ„Å´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´„Åî„Å®„ÅÆÊ∏¨ÂÆöÁµêÊûú„ÇíÈõÜÁ¥Ñ„Åô„Çã„ÄÅ„Å®„ÅÑ„ÅÜ„Çà„ÅÜ„Å™„Éó„É≠„Çª„Çπ„ÅØÁô∫Áîü„Åó„Å™„ÅÑ„ÄÇÔºàË§áÊï∞ÂõûÂÆüË°å„ÇÑÁï∞„Å™„ÇãÂÆüË°åÂΩ¢Âºè„ÅÆÂÆüË°åÁµêÊûú„ÇíÈõÜÁ¥Ñ„Åô„ÇãÂ†¥Âêà„ÅØ„ÄÅÂæåËø∞„Åô„Çã„Çà„ÅÜ„Å´`llvm-profdata merge`„Å´„Çà„ÇãÈõÜÁ¥Ñ„ÅåÂøÖË¶Å„Å®„Å™„Çã„ÄÇÔºâ

## 3. „Ç´„Éê„É¨„ÉÉ„Ç∏ÈõÜÁ¥Ñ

Áîü„Éó„É≠„Éï„Ç°„Ç§„É´Ôºà`.profraw`Ôºâ„ÅØ„Åù„ÅÆ„Åæ„Åæ„Åß„ÅØ„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„ÇíË°®Á§∫„Åß„Åç„Åö„ÄÅ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂåñ„Çí„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„ÄÇ„Åì„Çå„Å´„ÅØ`llvm-profdata merge`„Çí‰ΩøÁî®„Åô„Çã„ÄÇ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂåñ„Çí„Åó„Åü„ÅÇ„Å®„ÅØ„ÄÅÁîü„Éó„É≠„Éï„Ç°„Ç§„É´„ÅØ‰∏çË¶Å„Åß„ÅÇ„Çã„Åü„ÇÅÂâäÈô§„Åó„Å¶„ÇÇÂïèÈ°å„Å™„ÅÑ„ÄÇ

```sh
# Áîü„Éó„É≠„Éï„Ç°„Ç§„É´„Çí„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπÂåñ„Åô„Çã
llvm-profdata-20 merge -sparse main.profraw -o main.profdata
```

:::message
`-sparse`„Ç™„Éó„Ç∑„Éß„É≥„Å´„Çà„Å£„Å¶„ÄÅ`.profdata`„ÅÆ„Çµ„Ç§„Ç∫„ÇíÁØÄÁ¥Ñ„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Çã„Åü„ÇÅ„ÄÅÂü∫Êú¨ÁöÑ„Å´„ÅØÊåáÂÆö„Åô„Çå„Å∞„Çà„ÅÑ„ÄÇ„Åü„Å†„Åó„ÄÅ„Éó„É≠„Éï„Ç°„Ç§„É´ÁµêÊûú„ÇíÊúÄÈÅ©Âåñ„ÅÆÊùêÊñô„Å®„Åó„Å¶‰Ωø„ÅÜPGO (Profile Guided Optimization)„ÅÆÂ†¥Âêà„Å´„ÅØ‰ΩøÁî®„ÅåÊé®Â•®„Åï„Çå„Å™„ÅÑ„ÄÇ
:::

`llvm-profdata merge`„ÅØ„ÄÅË§áÊï∞„ÅÆÁîü„Éó„É≠„Éï„Ç°„Ç§„É´„ÇÑ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ªò„Åç„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíÈõÜÁ¥Ñ„Åô„Çã„Åì„Å®„ÇÇÂèØËÉΩ„Åß„ÅÇ„Çã„ÄÇ‰æã„Åà„Å∞„ÄÅÂÖ±Êúâ„É©„Ç§„Éñ„É©„É™„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏„ÇíË®àÊ∏¨„Åô„Çã„Åü„ÇÅ„Å´„ÄÅÁï∞„Å™„Çã„Éê„Ç§„Éä„É™„ÇíÂÆüË°å„Åó„ÅüÁµêÊûú„ÇíÈõÜÁ¥Ñ„Åô„Çã„Å®„ÅÑ„Å£„ÅüÁî®ÈÄî„Åß‰Ωø„Åà„Çã„ÄÇ

```sh
# Áîü„Éó„É≠„Éï„Ç°„Ç§„É´ÂêåÂ£´„ÅÆ„Éû„Éº„Ç∏„ÅåÂèØËÉΩ
llvm-profdata merge -sparse foo1.profraw foo2.profraw -o foo3.profdata

# „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ªò„Åç„Éó„É≠„Éï„Ç°„Ç§„É´„ÅÆ„Éû„Éº„Ç∏„ÇÇÂèØËÉΩ
llvm-profdata merge -sparse foo1.profraw foo2.profdata -o foo3.profdata
```

## 4. „Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûúË°®Á§∫

„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ‰ªò„Åç„Éó„É≠„Éï„Ç°„Ç§„É´(`.profdata`)„ÅØ„ÄÅÂÆüË°åÂΩ¢Âºè„ÇÇÊ∏°„Åô„Åì„Å®„Åß`llvm-cov show`„Å´„Çà„Å£„Å¶Ë°®Á§∫„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Çã„ÄÇ

```sh
llvm-cov-20 show ./main -instr-profile=main.profdata \
    -Xdemangler=c++filt \
    -show-mcdc \
    -show-line-counts-or-regions \
    -show-branches=count
```

:::message
- `-Xdemangler=c++filt`„ÅØ„ÄÅC++„ÅßÈñ¢Êï∞Âêç„ÇÑ„ÇØ„É©„ÇπÂêç„ÅåÈõ£Ë™≠Âåñ„Åï„Çå„Å¶„Åó„Åæ„ÅÜ„ÇÇ„ÅÆ„ÇíË™≠„Åø„ÇÑ„Åô„ÅÑÂΩ¢„Å´„Åô„ÇãÂäπÊûú„Åå„ÅÇ„ÇãÔºà„Éá„Éû„É≥„Ç∞„É´Ôºâ„ÄÇ
- `-show-mcdc`„ÅØ„ÄÅMDCD„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ„Å´ÊåáÂÆö„Åó„Å¶„ÅÑ„Çã„ÄÇ
- `-show-line-counts-or-regions`„ÅØ„ÄÅË°å„É¨„Éô„É´„ÅÆÂÆüË°åÂõûÊï∞„Å®Ë°åÂÜÖ„ÅÆË¶ÅÁ¥†„ÅÆÂÆüË°åÂõûÊï∞„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„Å´ÂæåËÄÖ„Çí`^`„ÅßÂà•ÈÄîË°®Á§∫„Åô„ÇãÂäπÊûú„ÇíÊåÅ„Å§„ÄÇ
- `show-branches=count`„ÅØ„ÄÅÂêÑÊù°‰ª∂ÂàÜÂ≤ê„ÅÆÂÆüÁèæÂõûÊï∞„ÇíË°®Á§∫„Åô„Çã„ÄÇ

„Åù„ÅÆ‰ªñ„ÄÅ‰ΩøÁî®ÂèØËÉΩ„Å™„Ç™„Éó„Ç∑„Éß„É≥„Å´„Å§„ÅÑ„Å¶„ÅØ[„Åì„Å°„Çâ](https://llvm.org/docs/CommandGuide/llvm-cov.html#id5)„ÇíÂèÇÁÖß„ÄÇ
:::

ÂÆüË°åÁµêÊûú„ÅØ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´„Å™„Çã„ÄÇË¶ã„Å¶ÂàÜ„Åã„Çã„Çà„ÅÜ„Å´„ÄÅ

- Èùû„ÉÜ„É≥„Éó„É¨„Éº„ÉàÈñ¢Êï∞`bar`„ÅØ„ÄÅMC/DC„Ç´„Éê„É¨„ÉÉ„Ç∏„Åå100%„Å®„Å™„Å£„Åü„ÄÇ
- „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈñ¢Êï∞`foo`„ÅØ„ÄÅ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éë„É©„É°„Éº„Çø„Åî„Å®„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„ÅåÈõÜË®à„Åï„Çå„Å¶„Åä„Çä„ÄÅ„Åù„Çå„Åû„Çå„ÅÆMC/DC„Ç´„Éê„É¨„ÉÉ„Ç∏„ÅØ100%„Å®„Å™„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÄÇ

```sh
/path/to/sample_codes/clang-source-based-coverage/bar.cpp:
    1|       |#include "bar.hpp"
    2|       |
    3|      3|void bar(const int x, const int y) {
    4|      3|  if ((x > 0) && (y > 0)) {
                               ^2
  ------------------
  |  Branch (4:7): [True: 2, False: 1]
  |  Branch (4:18): [True: 1, False: 1]
  ------------------
  |---> MC/DC Decision Region (4:7) to (4:25)
  |
  |  Number of Conditions: 2
  |     Condition C1 --> (4:7)
  |     Condition C2 --> (4:18)
  |
  |  Executed MC/DC Test Vectors:
  |
  |     C1, C2    Result
  |  1 { F,  -  = F      }
  |  2 { T,  F  = F      }
  |  3 { T,  T  = T      }
  |
  |  C1-Pair: covered: (1,3)
  |  C2-Pair: covered: (2,3)
  |  MC/DC Coverage for Decision: 100.00%
  |
  ------------------
    5|      1|    volatile int i = 0;
    6|      2|  } else {
    7|      2|    volatile int i = 1;
    8|      2|  }
    9|      3|}

/path/to/sample_codes/clang-source-based-coverage/foo.hpp:
    1|       |#pragma once
    2|       |
    3|       |template <typename T>
    4|      3|void foo(const T x, const T y) {
    5|      3|  if ((x > 0) && (y > 0)) {
                               ^2
  ------------------
  |  Branch (5:7): [True: 2, False: 0]
  |  Branch (5:18): [True: 1, False: 1]
  |  Branch (5:7): [True: 0, False: 1]
  |  Branch (5:18): [True: 0, False: 0]
  ------------------
  |---> MC/DC Decision Region (5:7) to (5:25)
  |
  |  Number of Conditions: 2
  |     Condition C1 --> (5:7)
  |     Condition C2 --> (5:18)
  |
  |  Executed MC/DC Test Vectors:
  |
  |     C1, C2    Result
  |  1 { T,  F  = F      }
  |  2 { T,  T  = T      }
  |
  |  C1-Pair: not covered
  |  C2-Pair: covered: (1,2)
  |  MC/DC Coverage for Decision: 50.00%
  |
  |---> MC/DC Decision Region (5:7) to (5:25)
  |
  |  Number of Conditions: 2
  |     Condition C1 --> (5:7)
  |     Condition C2 --> (5:18)
  |
  |  Executed MC/DC Test Vectors:
  |
  |     C1, C2    Result
  |  1 { F,  -  = F      }
  |
  |  C1-Pair: not covered
  |  C2-Pair: not covered
  |  MC/DC Coverage for Decision: 0.00%
  |
  ------------------
    6|      1|    volatile int i = 0;
    7|      2|  } else {
    8|      2|    volatile int i = 1;
    9|      2|  }
   10|      3|}
  ------------------
  | void foo<int>(int, int):
  |    4|      2|void foo(const T x, const T y) {
  |    5|      2|  if ((x > 0) && (y > 0)) {
  |  ------------------
  |  |  Branch (5:7): [True: 2, False: 0]
  |  |  Branch (5:18): [True: 1, False: 1]
  |  ------------------
  |  |---> MC/DC Decision Region (5:7) to (5:25)
  |  |
  |  |  Number of Conditions: 2
  |  |     Condition C1 --> (5:7)
  |  |     Condition C2 --> (5:18)
  |  |
  |  |  Executed MC/DC Test Vectors:
  |  |
  |  |     C1, C2    Result
  |  |  1 { T,  F  = F      }
  |  |  2 { T,  T  = T      }
  |  |
  |  |  C1-Pair: not covered
  |  |  C2-Pair: covered: (1,2)
  |  |  MC/DC Coverage for Decision: 50.00%
  |  |
  |  ------------------
  |    6|      1|    volatile int i = 0;
  |    7|      1|  } else {
  |    8|      1|    volatile int i = 1;
  |    9|      1|  }
  |   10|      2|}
  ------------------
  | void foo<long>(long, long):
  |    4|      1|void foo(const T x, const T y) {
  |    5|      1|  if ((x > 0) && (y > 0)) {
  |                               ^0
  |  ------------------
  |  |  Branch (5:7): [True: 0, False: 1]
  |  |  Branch (5:18): [True: 0, False: 0]
  |  ------------------
  |  |---> MC/DC Decision Region (5:7) to (5:25)
  |  |
  |  |  Number of Conditions: 2
  |  |     Condition C1 --> (5:7)
  |  |     Condition C2 --> (5:18)
  |  |
  |  |  Executed MC/DC Test Vectors:
  |  |
  |  |     C1, C2    Result
  |  |  1 { F,  -  = F      }
  |  |
  |  |  C1-Pair: not covered
  |  |  C2-Pair: not covered
  |  |  MC/DC Coverage for Decision: 0.00%
  |  |
  |  ------------------
  |    6|      0|    volatile int i = 0;
  |    7|      1|  } else {
  |    8|      1|    volatile int i = 1;
  |    9|      1|  }
  |   10|      1|}
  ------------------

/path/to/sample_codes/clang-source-based-coverage/main.cpp:
    1|       |#include "foo.hpp"
    2|       |#include "bar.hpp"
    3|       |
    4|      1|int main() {
    5|      1|  bar(2, 3);
    6|      1|  bar(2, -5);
    7|      1|  bar(-3, 3);
    8|       |
    9|      1|  foo<int>(2, 3);
   10|      1|  foo<int>(2, -5);
   11|      1|  foo<long>(-3, 3);
   12|       |
   13|     11|  for (int i = 0; i < 10; ++i) {
                                        ^10
  ------------------
  |  Branch (13:19): [True: 10, False: 1]
  ------------------
   14|     10|    volatile int j = i;
   15|     10|  }
   16|       |
   17|      1|  return 0;
   18|      1|}
```


HTML„Éö„Éº„Ç∏„Å®„Åó„Å¶Ë°®Á§∫„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄÅ`-format=html -output-dir=<path/to/dir>`„ÇíËøΩÂä†„ÅßÊåáÂÆö„Åô„Çã„Å®„Çà„ÅÑ„ÄÇ

```sh
llvm-cov-20 show ./main -instr-profile=main.profdata \
    -Xdemangler=c++filt \
    -show-mcdc \
    -show-line-counts-or-regions \
    -show-branches=count \
    -format=html \
    -output-dir=coverage_html
```

ÂÖ®‰Ωì„ÅÆ„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„Å®„Åù„Çå„Åû„Çå„ÅÆ„Éï„Ç°„Ç§„É´„Åî„Å®„ÅÆË©≥Á¥∞„Å™„Ç´„Éê„É¨„ÉÉ„Ç∏ÁµêÊûú„Åå„Ç∞„É©„Éï„Ç£„Ç´„É´„Å´Èñ≤Ë¶ß„Åß„Åç„Çã„ÄÇ

![](/images/clang-source-based-coverage/image_1.png =600x)

![](/images/clang-source-based-coverage/image_2.png =600x)

ÂÖ®‰Ωì„ÅÆ„É¨„Éù„Éº„Éà„ÅØ„ÄÅCLI„Åß„ÇÇ`llvm-cov repot`„ÇíÁî®„ÅÑ„Å¶Ë°®Á§∫„Åô„Çã„Åì„Å®„ÅåÂèØËÉΩ„Åß„ÅÇ„Çã„ÄÇ

```sh
$ llvm-cov-20 report ./main -instr-profile=main.profdata -Xdemangler=c++filt -show-mcdc-summary
Filename                      Regions    Missed Regions     Cover   Functions  Missed Functions  Executed       Lines      Missed Lines     Cover    Branches   Missed Branches     Cover    MC/DC Conditions    Missed Conditions     Cover
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
bar.cpp                             6                 0   100.00%           1                 0   100.00%           7                 0   100.00%           4                 0   100.00%                   2                    0   100.00%
foo.hpp                             6                 0   100.00%           1                 0   100.00%           7                 0   100.00%           4                 1    75.00%                   2                    1    50.00%
main.cpp                            4                 0   100.00%           1                 0   100.00%          12                 0   100.00%           2                 0   100.00%                   0                    0         -
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
TOTAL                              16                 0   100.00%           3                 0   100.00%          26                 0   100.00%          10                 1    90.00%                   4                    1    75.00%
```

:::message
`-show-mcdc-summary`„ÇÇÊåáÂÆö„Åô„Çã„Åì„Å®„Åß„ÄÅ‰∏äË®ò„ÅÆ„Çà„ÅÜ„Å´„É¨„Éù„Éº„Éà„Å´MC/DC„ÅÆÁµ±Ë®àÁµêÊûú„ÇÇË°®Á§∫„Åß„Åç„Çã„ÄÇ
:::