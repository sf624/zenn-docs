---
title: "球面線形補完 (Slerp)"
free: false
---

# クォータニオンの場合

クォータニオンの球面線形補完は、始終点のクォータニオンの重み付き加重和として計算できるため、非常に求めやすい。

$$
\operatorname{slerp}(q_0, q_1; t) = \dfrac{\sin((1-t)\theta)}{\sin\theta}q_0 + \dfrac{\sin t\theta}{\sin\theta}q_1
$$

$$
\theta = \arccos(q_0 \cdot q_1)
$$

ただし、$q_1 \cdot q_2$はクォータニオン積（ハミルトン積）ではなく4次元ベクトルとして見たときのドット積である。

ただし、数値計算を実施する場合の追加事項として、$\theta$が微小な時は$\dfrac{\sin(t\theta)}{\theta} \approx t$であるから、

$$
\operatorname{slerp}(q_0, q_1; t) = (1-t) q_0 + t q_1 \quad\text{(if t ≈ 0)}
$$

と近似することで0除算を回避する。（これはただの線形補完である）

## 導出過程

$q_0$から$\Delta q$だけ回転したときに$q_1$が得られるのであれば、

$$
q_0  \Delta q = q_1
$$

であるので、$\Delta q = q_0^* q_1$である。従って、クォータニオンのべき乗が計算できるのであれば、この$\Delta q$を用いて

$$
\operatorname{slerp}(q_0, q_1; t) = q_0 \Delta q^t
$$

と定義することができる。

$\Delta q$も単位クォータニオンであるから、ある角度$\theta$、単位ベクトル$\vec{n}$を用いて

$$
\Delta q = \cos\theta + \sin\theta\,\vec{n}
$$

とすることができる。すると、

$$
\Delta q^t = \cos(t\theta)  + \sin(t\theta)\,\vec{n}
$$

のようにべき乗を定めることができる。よって、

$$
\operatorname{slerp}(q_0, q_1; t) = q_0 \left[ \cos(t\theta)  + \sin(t\theta)\,\vec{n} \right] = \cos(t\theta)q_0 + \sin(t\theta) (q_0 \vec{n})
$$

となる。一方で、

$$
q_1 = q_0 \Delta q = \cos\theta + \sin\theta\,\vec{n}
$$

であるため、slerpを$q_0$と$q_1$の重み加重和で表現できると仮定すると、

$$
\operatorname{slerp}(q_0, q_1; t) = a(t)q_0 + b(t)q_1
$$
$$
= a(t)q_0 + b(t) \left[\cos\theta + \sin\theta\,\vec{n}\right] \\
$$
$$
= \left[a(t)+b(t)\cos\theta\right]q_0+b(t)\sin\theta (q_0\vec{n})
$$

とならなければならない。つまり先ほどのslerpの式と係数比較をして、

$$
a(t)+b(t)\cos\theta = \cos(t\theta)
$$

$$
b(t)\sin\theta = \sin(t\theta)
$$

となるように、$a(t)$と$b(t)$を設定すればよい。まず、直ちに

$$
b(t) = \dfrac{\sin(t\theta)}{\sin\theta}
$$

が得られ、三角関数の加法定理を経由することで、

$$
a(t) = \cos(t\theta) - \dfrac{\sin(t\theta)}{\sin\theta}\cos\theta
$$

$$
= \dfrac{\sin\theta\cos(t\theta)-\cos\theta\sin(t\theta)}{\sin\theta}
$$

$$
= \dfrac{\sin((1-t)\theta)}{\sin\theta}
$$

が得られる。

また、$\theta$については$q_0 = a + bi + cj + dk, q_1 = w + xi + yj + zk$とおいて、$\Delta q = q_0^* q_1$の成分計算を実際に実施してみると、

$$
\Delta q = q_0^* q_1 = (a - bi - cj - dk)(w + xi + yj + zk) \\
= (aw + bx + cy + dz) + (虚部)
$$

となり、実部について$\cos\theta = (aw + bx + cy + dz) = q_0 \cdot q_1$が成立し、従って$\theta = \arccos(q_0 \cdot q_1)$である。

以上より、slerpの公式が導かれる。


# 回転行列の場合

$$
\operatorname{slerp}(R_0, R_1; t) = R_0 \exp \left(t \cdot \log (R_0^T R_1) \right) =  I + \sin t[n]_\times + (1-\cos t)[n]_\times^2
$$

$$
[n]_\times = \begin{bmatrix}0&-r_3&r_2\\r_3&0&-r_1\\-r_2&r_1&0\end{bmatrix}
$$

$$
\begin{bmatrix}r_1\\r_2\\r_3\end{bmatrix}= \dfrac{1}{2\sin\theta} \begin{bmatrix}\Delta R_{32}-\Delta R_{23}\\\Delta R_{13}-\Delta R_{31}\\\Delta R_{21}-\Delta R_{12}\end{bmatrix}
$$

$$
\theta = \arccos \left( \dfrac{\operatorname{tr}(\Delta R)-1}{2} \right)
$$

ただし、$\Delta R = R_0^T R_1$である。

対数写像$\log(\cdot)$と指数写像$\exp(\cdot)$は下記の計算手順で定義される。

## 指数写像

一般の行列$A$に対しては、普通の指数関数のテイラー展開に行列$A$を代入したものである。つまり、

$$
\exp (A) \triangleq \sum_{n=0}^{\infty}\dfrac{A^n}{n!} = I + A + \dfrac{A^2}{2!} + \dfrac{A^3}{3!} + \cdots
$$

である。

ただし、単位ベクトルnに対して定める歪対称行列（クロス積行列）

$$
[n]_\times = \begin{bmatrix}0&-n_z&n_y\\n_z&0&-n_x\\-n_y&n_x&0\end{bmatrix}
$$

については、$[n]_\times^3 = -[n]_\times$となることから、$\sin$と$\cos$のテイラー展開も使うことで

$$
\exp (\theta [n]_\times) = I + \theta [n]_\times + \dfrac{\theta^2 [n]_\times^2}{2!} + \dfrac{\theta^3 [n]_\times^3}{3!} + \cdots
$$

$$
= I + \left(\theta - \dfrac{\theta^3}{3!} + \dfrac{\theta^5}{5!}\right) [n]_\times + \left(\dfrac{\theta^2}{2!} - \dfrac{\theta^4}{4!} + \dfrac{\theta^6}{6!} \cdots\right) [n]_\times^2
$$

$$
= I + \sin\theta[n]_\times + (1-\cos\theta)[n]_\times^2
$$

となる。

余談であるが、普通の指数関数に対して

$$
\exp (i\theta) = \cos\theta + i\sin\theta = 1 + i\sin\theta + (1-\cos\theta) i^2
$$

であるように、歪対称行列は行列の世界における虚数のようなものだとアナロジーを取ることができる。

## 対数写像

指数写像の逆写像である。一般の行列すべてで存在するわけではないが、直行行列$R$に対しては必ず存在し、

$$
\theta = \arccos \left( \dfrac{\operatorname{tr}(R)-1}{2} \right)
$$

$$
r = \dfrac{1}{2\sin\theta} \begin{bmatrix}R_{32}-R_{23}\\R_{13}-R_{31}\\R_{21}-R_{12}\end{bmatrix}
$$

$$
\log(R) = \theta \begin{bmatrix}0&-r_3&r_2\\r_3&0&-r_1\\-r_2&r_1&0\end{bmatrix}
$$

である。

## 導出過程

回転行列$R_0$に同一の微小回転を表す行列$δR$をn回かけると回転行列$R_1$が得られるとしよう。

$$
R_0 (δR)^n = R_1　\rightarrow δR = (R_0^T R_1)^{1/n}
$$

このとき、$R_0$と$R_1$を$t:1-t$に内分する回転行列$\operatorname{slerp}(R_0, R_1; t)$は、$k=tn$と置くと

$$
\operatorname{slerp}(R_0, R_1; t) = R_1 (δR)^{k} = R_1 (R_1^T R_2)^{k/n}
$$

のように自然に定義することができ、$n\rightarrow\infty$の極限を取り、

$$
\operatorname{slerp}(R_0, R_1; t) = R_1 (R_1^T R_2)^{t}
$$

と定義することができる。

一般に正則行列$A$が対角化可能である場合、正則行列$P$と対角行列$D$を用いて、

$$
A = P D P^{-1}
$$

$$
D \triangleq \operatorname{diag}(\lambda_1, \lambda_2, ..., \lambda_n)
$$

と対角化が可能である。ここで$\lambda_i$は$A$の固有値であるため固有値分解とも呼ばれる。このことから、正則行列$A$の$t$乗とは

$$
A^t = P D^t P^{-1}
$$

$$
D \triangleq \operatorname{diag}(\lambda_1^t, \lambda_2^t, ..., \lambda_n^t)
$$

として自然に定めることができる。（$A^{1/2} A^{1/2} = A$になることを確かめてみるとよい。)

このことから、回転行列も正則行列であるため

$$
\operatorname{slerp}(R_0, R_1; t) = R_0 (R_0^T R_1)^{t}
$$

と定めることが可能となる。これが球面線形補完に対応する。

特に、指数写像と対数写像を導入すれば、

$$
\operatorname{slerp}(R_0, R_1; t) = R_0 \exp \left(t \cdot \log (R_0^T R_1) \right)
$$

である。

## 指数写像


$R_0^T R_1$も回転行列であり、これを$\Delta R$と定義する。$\Delta R$の回転軸ベクトルを$n=(n_x,n_y,n_z)^T$、回転角を$\theta = \arccos(\dfrac{\operatorname{Tr}(R)-1}{2})$と置くと、$\Delta R = P D P^{-1}$の固有値分解は

$$
\theta = \arccos(\dfrac{\operatorname{Tr}(R)-1}{2})
$$

$$
n_x = \dfrac{R_{32}-R_{23}}{2\sin\theta}
$$

$$
n_y = \dfrac{R_{13}-R_{31}}{2\sin\theta}
$$

$$
n_z = \dfrac{R_{21}-R_{12}}{2\sin\theta}
$$

$$
D = \begin{bmatrix} 1 & 0 & 0 \\ 0 & e^{i\theta} & 0 \\ 0 & 0 & e^{-i\theta} \end{bmatrix}
$$

$$
P = \begin{bmatrix} n_x & a_1 + ib_1 & a_1 - ib_1 \\ n_y & a_2 + ib_2 & a_2 - ib_2 \\ n_z & a_3 + ib_3 & a_3 - ib_3 \end{bmatrix}
$$

として求めることができる。ただし、$(a_1, a_2, a_3)^T$と$(b_1, b_2, b_3)^T$は$(n_x, n_y, n_z)^T$に垂直な任意の実ベクトルであって、グラム・シュミットの正規直交化法などによって求めることができる。これにより、

$$
\Delta R = P \begin{bmatrix} 1 & 0 & 0 \\ 0 & e^{i\theta} & 0 \\ 0 & 0 & e^{-i\theta} \end{bmatrix} P^{-1}
$$

##